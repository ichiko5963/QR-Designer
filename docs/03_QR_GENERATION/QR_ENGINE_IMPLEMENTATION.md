# QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³ å®Œå…¨å®Ÿè£…ã‚¬ã‚¤ãƒ‰ - QR Designer v3.0

## ğŸ“š ç›®æ¬¡

1. [QRã‚³ãƒ¼ãƒ‰æŠ€è¡“ã®åŸºç¤](#qrã‚³ãƒ¼ãƒ‰æŠ€è¡“ã®åŸºç¤)
2. [ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé¸å®šã¨çµ±åˆ](#ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé¸å®šã¨çµ±åˆ)
3. [é«˜å“è³ªç”»åƒç”Ÿæˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³](#é«˜å“è³ªç”»åƒç”Ÿæˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³)
4. [ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ©Ÿèƒ½å®Ÿè£…](#ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ©Ÿèƒ½å®Ÿè£…)
5. [ãƒ­ã‚´åˆæˆã¨ç”»åƒå‡¦ç†](#ãƒ­ã‚´åˆæˆã¨ç”»åƒå‡¦ç†)
6. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–)
7. [æœ¬ç•ªç’°å¢ƒã§ã®è€ƒæ…®äº‹é …](#æœ¬ç•ªç’°å¢ƒã§ã®è€ƒæ…®äº‹é …)

---

## QRã‚³ãƒ¼ãƒ‰æŠ€è¡“ã®åŸºç¤

### QRã‚³ãƒ¼ãƒ‰ã®æ§‹é€ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”â”â”â”â”“         â”â”â”â”â”“               â”‚
â”‚ â”ƒâ–ˆâ–ˆâ–ˆâ”ƒ         â”ƒâ–ˆâ–ˆâ–ˆâ”ƒ  â† ä½ç½®æ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³
â”‚ â”ƒâ–ˆ â–ˆâ”ƒ         â”ƒâ–ˆ â–ˆâ”ƒ     (Finder Pattern)
â”‚ â”ƒâ–ˆâ–ˆâ–ˆâ”ƒ         â”ƒâ–ˆâ–ˆâ–ˆâ”ƒ               â”‚
â”‚ â”—â”â”â”â”›         â”—â”â”â”â”›               â”‚
â”‚                                    â”‚
â”‚         [ãƒ‡ãƒ¼ã‚¿é ˜åŸŸ]                â”‚
â”‚    (ã‚¨ãƒ©ãƒ¼è¨‚æ­£ + å®Ÿãƒ‡ãƒ¼ã‚¿)           â”‚
â”‚                                    â”‚
â”‚ â”â”â”â”â”“                             â”‚
â”‚ â”ƒâ–ˆâ–ˆâ–ˆâ”ƒ  â† ä½ç½®æ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³            â”‚
â”‚ â”ƒâ–ˆ â–ˆâ”ƒ                             â”‚
â”‚ â”ƒâ–ˆâ–ˆâ–ˆâ”ƒ         [ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³]  â”‚
â”‚ â”—â”â”â”â”›                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚¨ãƒ©ãƒ¼è¨‚æ­£ãƒ¬ãƒ™ãƒ«

| ãƒ¬ãƒ™ãƒ« | è¨‚æ­£èƒ½åŠ› | æ¨å¥¨ç”¨é€” | ãƒ‡ãƒ¼ã‚¿å®¹é‡ |
|--------|---------|---------|----------|
| L (Low) | ~7% | ãƒ‡ã‚¸ã‚¿ãƒ«è¡¨ç¤ºå°‚ç”¨ | æœ€å¤§ |
| M (Medium) | ~15% | é€šå¸¸ç”¨é€” | å¤§ |
| Q (Quartile) | ~25% | **æ¨å¥¨ï¼ˆQR Designerï¼‰** | ä¸­ |
| H (High) | ~30% | æ±šã‚Œãƒ»æå‚·æƒ³å®š | æœ€å° |

**QR Designer v3.0ã®é¸æŠ: Q (Quartile)**
- ãƒ­ã‚´æŒ¿å…¥æ™‚ã®å®‰å…¨æ€§ç¢ºä¿
- ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸç‡ã¨ãƒ‡ãƒ¼ã‚¿å®¹é‡ã®ãƒãƒ©ãƒ³ã‚¹

### ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿å®¹é‡

```typescript
// è‹±æ•°å­—ãƒ¢ãƒ¼ãƒ‰ã®æœ€å¤§æ–‡å­—æ•°
const MAX_CHARS = {
  1: 25,   // 21x21ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
  10: 174, // 57x57ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
  20: 370, // 97x97ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
  40: 1852 // 177x177ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆæœ€å¤§ï¼‰
}

// URLã®è‡ªå‹•ãƒãƒ¼ã‚¸ãƒ§ãƒ³é¸æŠ
function selectVersion(url: string): number {
  const length = url.length

  if (length <= 100) return 10  // é€šå¸¸ã®URL
  if (length <= 200) return 15  // é•·ã„URL
  if (length <= 300) return 20  // éå¸¸ã«é•·ã„URL
  return 25 // æ¥µç«¯ã«é•·ã„URL
}
```

---

## ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé¸å®šã¨çµ±åˆ

### ä¸»è¦QRã‚³ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ¯”è¼ƒ

| ãƒ©ã‚¤ãƒ–ãƒ©ãƒª | ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º | ã‚µãƒ¼ãƒãƒ¼å¯¾å¿œ | ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚º | å“è³ª | åˆ¤å®š |
|-----------|------------|------------|-------------|------|------|
| qrcode | â­â­ | âœ… | 42KB | â­â­â­â­ | âœ… |
| qrcode-generator | â­ | âœ… | 15KB | â­â­â­ | âŒ |
| node-qrcode | â­â­â­ | âœ… | 58KB | â­â­â­â­ | âœ… |
| qr-code-styling | â­â­â­â­â­ | âŒ | 156KB | â­â­â­â­â­ | âŒ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã¿ |
| awesome-qr | â­â­â­â­ | âš ï¸ | 89KB | â­â­â­â­ | âŒ è¤‡é›‘ |

**é¸å®š: `qrcode` + `sharp`**
- ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å¯¾å¿œï¼ˆNext.js API Routesï¼‰
- è»½é‡ï¼ˆ42KBï¼‰
- ã‚·ãƒ³ãƒ—ãƒ«ãªAPI
- Sharpã§å¾Œå‡¦ç†ã—ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¼·åŒ–

### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# QRç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª
npm install qrcode

# ç”»åƒå‡¦ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
npm install sharp

# å‹å®šç¾©
npm install -D @types/qrcode
```

### åŸºæœ¬çš„ãªçµ±åˆ

```typescript
// lib/qr/generator.ts
import QRCode from 'qrcode'
import sharp from 'sharp'

/**
 * åŸºæœ¬çš„ãªQRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
 */
export async function generateBasicQR(url: string): Promise<Buffer> {
  // SVGå½¢å¼ã§ç”Ÿæˆï¼ˆé«˜å“è³ªï¼‰
  const qrSvg = await QRCode.toString(url, {
    type: 'svg',
    width: 512,
    margin: 1,
    errorCorrectionLevel: 'Q',
    color: {
      dark: '#000000',
      light: '#FFFFFF'
    }
  })

  // SVGã‚’PNGã«å¤‰æ›
  const pngBuffer = await sharp(Buffer.from(qrSvg))
    .resize(512, 512)
    .png({ quality: 95, compressionLevel: 9 })
    .toBuffer()

  return pngBuffer
}
```

---

## é«˜å“è³ªç”»åƒç”Ÿæˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

### ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ•ãƒ­ãƒ¼

```mermaid
graph LR
    A[URL] --> B[QRCode.toString]
    B --> C[SVGç”Ÿæˆ]
    C --> D[Sharp: SVG â†’ PNGå¤‰æ›]
    D --> E{ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º?}
    E -->|Yes| F[è‰²é©ç”¨]
    F --> G[ãƒ­ã‚´åˆæˆ]
    G --> H[è§’ä¸¸é©ç”¨]
    E -->|No| I[åŸºæœ¬QRã‚³ãƒ¼ãƒ‰]
    H --> J[æœ€çµ‚PNGå‡ºåŠ›]
    I --> J
```

### å®Œå…¨ãªç”Ÿæˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè£…

```typescript
// lib/qr/generator.ts
import QRCode from 'qrcode'
import sharp from 'sharp'
import type { Design, Customization } from '@/types/design'

export interface QRCodeOptions {
  url: string
  design: Design
  customization: Customization
  logo?: Buffer
}

/**
 * é«˜å“è³ªQRã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯¾å¿œï¼‰
 */
export async function generateQRCode(
  options: QRCodeOptions
): Promise<Buffer> {
  const { url, design, customization, logo } = options

  // ã‚¹ãƒ†ãƒƒãƒ—1: SVGç”Ÿæˆ
  const qrSvg = await generateQRSVG(url, design, customization)

  // ã‚¹ãƒ†ãƒƒãƒ—2: PNGå¤‰æ›
  let qrBuffer = await convertSVGtoPNG(qrSvg, customization.size)

  // ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ­ã‚´åˆæˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  if (logo) {
    qrBuffer = await composeLogo(qrBuffer, logo, customization)
  }

  // ã‚¹ãƒ†ãƒƒãƒ—4: è§’ä¸¸é©ç”¨ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  if (customization.cornerRadius > 0) {
    qrBuffer = await applyRoundedCorners(qrBuffer, customization)
  }

  return qrBuffer
}

/**
 * ã‚¹ãƒ†ãƒƒãƒ—1: QR SVGç”Ÿæˆ
 */
async function generateQRSVG(
  url: string,
  design: Design,
  customization: Customization
): Promise<string> {
  const qrSvg = await QRCode.toString(url, {
    type: 'svg',
    width: customization.size,
    margin: 1, // ãƒãƒ¼ã‚¸ãƒ³ã¯æœ€å°ã«ï¼ˆå¾Œå‡¦ç†ã§èª¿æ•´ï¼‰
    errorCorrectionLevel: customization.errorCorrectionLevel,
    color: {
      dark: design.fgColor,  // å‰æ™¯è‰²ï¼ˆQRã‚³ãƒ¼ãƒ‰æœ¬ä½“ï¼‰
      light: design.bgColor  // èƒŒæ™¯è‰²
    }
  })

  return qrSvg
}

/**
 * ã‚¹ãƒ†ãƒƒãƒ—2: SVG â†’ PNGå¤‰æ›
 */
async function convertSVGtoPNG(
  svgString: string,
  size: number
): Promise<Buffer> {
  return await sharp(Buffer.from(svgString))
    .resize(size, size, {
      fit: 'contain',
      background: { r: 255, g: 255, b: 255, alpha: 0 }
    })
    .png({
      quality: 95,
      compressionLevel: 9,
      adaptiveFiltering: true
    })
    .toBuffer()
}

/**
 * ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ­ã‚´åˆæˆ
 */
async function composeLogo(
  qrBuffer: Buffer,
  logoBuffer: Buffer,
  customization: Customization
): Promise<Buffer> {
  const size = customization.size
  const logoSizePercent = customization.logoSize
  const logoSize = Math.floor(size * (logoSizePercent / 100))

  // ãƒ­ã‚´ã‚’ãƒªã‚µã‚¤ã‚º
  const resizedLogo = await sharp(logoBuffer)
    .resize(logoSize, logoSize, {
      fit: 'contain',
      background: { r: 255, g: 255, b: 255, alpha: 0 }
    })
    .toBuffer()

  // é…ç½®ä½ç½®ï¼ˆä¸­å¤®ï¼‰
  const logoX = Math.floor((size - logoSize) / 2)
  const logoY = Math.floor((size - logoSize) / 2)

  // ç™½ã„èƒŒæ™¯ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  if (customization.logoBackground) {
    const padding = 10
    const bgSize = logoSize + padding * 2

    // ç™½èƒŒæ™¯ä½œæˆ
    const logoWithBg = await sharp({
      create: {
        width: bgSize,
        height: bgSize,
        channels: 4,
        background: { r: 255, g: 255, b: 255, alpha: 1 }
      }
    })
      .composite([
        {
          input: resizedLogo,
          left: padding,
          top: padding
        }
      ])
      .png()
      .toBuffer()

    // QRã‚³ãƒ¼ãƒ‰ã«åˆæˆ
    return await sharp(qrBuffer)
      .composite([
        {
          input: logoWithBg,
          left: logoX - padding,
          top: logoY - padding
        }
      ])
      .png()
      .toBuffer()
  } else {
    // èƒŒæ™¯ãªã—ã§ç›´æ¥åˆæˆ
    return await sharp(qrBuffer)
      .composite([
        {
          input: resizedLogo,
          left: logoX,
          top: logoY
        }
      ])
      .png()
      .toBuffer()
  }
}

/**
 * ã‚¹ãƒ†ãƒƒãƒ—4: è§’ä¸¸é©ç”¨
 */
async function applyRoundedCorners(
  qrBuffer: Buffer,
  customization: Customization
): Promise<Buffer> {
  const size = customization.size
  const radius = Math.floor(size * (customization.cornerRadius / 100))

  // SVGãƒã‚¹ã‚¯ä½œæˆ
  const roundedMask = Buffer.from(`
    <svg width="${size}" height="${size}">
      <rect
        x="0"
        y="0"
        width="${size}"
        height="${size}"
        rx="${radius}"
        ry="${radius}"
        fill="white"
      />
    </svg>
  `)

  // ãƒã‚¹ã‚¯é©ç”¨
  return await sharp(qrBuffer)
    .composite([
      {
        input: roundedMask,
        blend: 'dest-in'
      }
    ])
    .png()
    .toBuffer()
}

/**
 * DataURLå½¢å¼ã§å‡ºåŠ›ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶è¡¨ç¤ºç”¨ï¼‰
 */
export async function generateQRCodeAsDataURL(
  options: QRCodeOptions
): Promise<string> {
  const buffer = await generateQRCode(options)
  const base64 = buffer.toString('base64')
  return `data:image/png;base64,${base64}`
}
```

---

## ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ©Ÿèƒ½å®Ÿè£…

### ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚ªãƒ—ã‚·ãƒ§ãƒ³å‹å®šç¾©

```typescript
// types/design.ts

export interface Design {
  id: string
  name: string
  description: string
  fgColor: string  // å‰æ™¯è‰²ï¼ˆHEXï¼‰
  bgColor: string  // èƒŒæ™¯è‰²ï¼ˆHEXï¼‰
  style: 'bold' | 'minimal' | 'colorful' | 'elegant'
  cornerStyle: 'square' | 'rounded' | 'dots'
}

export interface Customization {
  size: number                          // 256-4096px
  cornerRadius: number                  // 0-50%
  logoSize: number                      // 10-35%
  logoBackground: boolean               // true/false
  errorCorrectionLevel: 'L' | 'M' | 'Q' | 'H'
  dotStyle: 'square' | 'rounded' | 'dots'
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
export const defaultCustomization: Customization = {
  size: 512,
  cornerRadius: 20,
  logoSize: 18,
  logoBackground: true,
  errorCorrectionLevel: 'Q',
  dotStyle: 'square'
}
```

### å‹•çš„ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºUI

```typescript
// app/components/CustomizePanel.tsx
'use client'

import { useState } from 'react'
import type { Customization } from '@/types/design'

interface CustomizePanelProps {
  customization: Customization
  onChange: (customization: Customization) => void
}

export default function CustomizePanel({
  customization,
  onChange
}: CustomizePanelProps) {
  const handleChange = (key: keyof Customization, value: any) => {
    onChange({ ...customization, [key]: value })
  }

  return (
    <div className="space-y-6 p-6 bg-white rounded-lg shadow">
      <h3 className="text-lg font-semibold">ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</h3>

      {/* ã‚µã‚¤ã‚º */}
      <div>
        <label className="block text-sm font-medium text-gray-700">
          ã‚µã‚¤ã‚º: {customization.size}px
        </label>
        <input
          type="range"
          min="256"
          max="2048"
          step="64"
          value={customization.size}
          onChange={(e) => handleChange('size', Number(e.target.value))}
          className="w-full mt-2"
        />
        <div className="flex justify-between text-xs text-gray-500 mt-1">
          <span>256px</span>
          <span>2048px</span>
        </div>
      </div>

      {/* è§’ã®ä¸¸ã¿ */}
      <div>
        <label className="block text-sm font-medium text-gray-700">
          è§’ã®ä¸¸ã¿: {customization.cornerRadius}%
        </label>
        <input
          type="range"
          min="0"
          max="50"
          step="5"
          value={customization.cornerRadius}
          onChange={(e) => handleChange('cornerRadius', Number(e.target.value))}
          className="w-full mt-2"
        />
      </div>

      {/* ãƒ­ã‚´ã‚µã‚¤ã‚º */}
      <div>
        <label className="block text-sm font-medium text-gray-700">
          ãƒ­ã‚´ã‚µã‚¤ã‚º: {customization.logoSize}%
        </label>
        <input
          type="range"
          min="10"
          max="35"
          step="1"
          value={customization.logoSize}
          onChange={(e) => handleChange('logoSize', Number(e.target.value))}
          className="w-full mt-2"
        />
      </div>

      {/* ãƒ­ã‚´èƒŒæ™¯ */}
      <div className="flex items-center">
        <input
          type="checkbox"
          id="logoBackground"
          checked={customization.logoBackground}
          onChange={(e) => handleChange('logoBackground', e.target.checked)}
          className="rounded"
        />
        <label htmlFor="logoBackground" className="ml-2 text-sm text-gray-700">
          ãƒ­ã‚´ã«ç™½ã„èƒŒæ™¯ã‚’è¿½åŠ 
        </label>
      </div>

      {/* ã‚¨ãƒ©ãƒ¼è¨‚æ­£ãƒ¬ãƒ™ãƒ« */}
      <div>
        <label className="block text-sm font-medium text-gray-700">
          ã‚¨ãƒ©ãƒ¼è¨‚æ­£ãƒ¬ãƒ™ãƒ«
        </label>
        <select
          value={customization.errorCorrectionLevel}
          onChange={(e) =>
            handleChange('errorCorrectionLevel', e.target.value)
          }
          className="mt-1 block w-full rounded-md border-gray-300"
        >
          <option value="L">L (7% - æœ€å¤§ãƒ‡ãƒ¼ã‚¿)</option>
          <option value="M">M (15% - æ¨™æº–)</option>
          <option value="Q">Q (25% - æ¨å¥¨)</option>
          <option value="H">H (30% - æœ€é«˜å“è³ª)</option>
        </select>
      </div>
    </div>
  )
}
```

---

## ãƒ­ã‚´åˆæˆã¨ç”»åƒå‡¦ç†

### ãƒ­ã‚´ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†

```typescript
// app/components/LogoUpload.tsx
'use client'

import { useState } from 'react'

interface LogoUploadProps {
  onLogoChange: (logo: Buffer | null) => void
}

export default function LogoUpload({ onLogoChange }: LogoUploadProps) {
  const [preview, setPreview] = useState<string | null>(null)

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]

    if (!file) {
      setPreview(null)
      onLogoChange(null)
      return
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ5MBåˆ¶é™ï¼‰
    if (file.size > 5 * 1024 * 1024) {
      alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„')
      return
    }

    // ç”»åƒå½¢å¼ãƒã‚§ãƒƒã‚¯
    if (!file.type.match(/^image\/(png|jpeg|jpg|webp)$/)) {
      alert('PNGã€JPEGã€ã¾ãŸã¯WebPå½¢å¼ã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„')
      return
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    const reader = new FileReader()
    reader.onload = (e) => {
      setPreview(e.target?.result as string)
    }
    reader.readAsDataURL(file)

    // Bufferã«å¤‰æ›ã—ã¦ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
    const arrayBuffer = await file.arrayBuffer()
    const buffer = Buffer.from(arrayBuffer)
    onLogoChange(buffer)
  }

  return (
    <div className="space-y-4">
      <label className="block text-sm font-medium text-gray-700">
        ãƒ­ã‚´ç”»åƒï¼ˆä»»æ„ï¼‰
      </label>

      {preview ? (
        <div className="relative">
          <img
            src={preview}
            alt="Logo preview"
            className="w-32 h-32 object-contain border rounded"
          />
          <button
            onClick={() => {
              setPreview(null)
              onLogoChange(null)
            }}
            className="absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6"
          >
            Ã—
          </button>
        </div>
      ) : (
        <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
          <input
            type="file"
            accept="image/png,image/jpeg,image/jpg,image/webp"
            onChange={handleFileChange}
            className="hidden"
            id="logoUpload"
          />
          <label
            htmlFor="logoUpload"
            className="cursor-pointer flex flex-col items-center"
          >
            <svg
              className="w-12 h-12 text-gray-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinecap="round"
                strokeWidth={2}
                d="M12 4v16m8-8H4"
              />
            </svg>
            <span className="mt-2 text-sm text-gray-600">
              ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            </span>
            <span className="mt-1 text-xs text-gray-500">
              PNG, JPEG, WebP (æœ€å¤§5MB)
            </span>
          </label>
        </div>
      )}
    </div>
  )
}
```

### ç”»åƒæœ€é©åŒ–ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

```typescript
// lib/image/optimize.ts
import sharp from 'sharp'

/**
 * ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ­ã‚´ã‚’æœ€é©åŒ–
 */
export async function optimizeLogo(buffer: Buffer): Promise<Buffer> {
  const image = sharp(buffer)
  const metadata = await image.metadata()

  // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿æŒã—ãªãŒã‚‰æ­£æ–¹å½¢ã«ãƒªã‚µã‚¤ã‚º
  const maxSize = 512

  let optimized = image.resize(maxSize, maxSize, {
    fit: 'contain',
    background: { r: 0, g: 0, b: 0, alpha: 0 } // é€é
  })

  // PNGå½¢å¼ã«çµ±ä¸€ï¼ˆé€éå¯¾å¿œï¼‰
  optimized = optimized.png({
    quality: 90,
    compressionLevel: 9
  })

  return await optimized.toBuffer()
}

/**
 * èƒŒæ™¯é™¤å»ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼‰
 */
export async function removeBackground(buffer: Buffer): Promise<Buffer> {
  // ç°¡æ˜“çš„ãªèƒŒæ™¯é™¤å»ï¼ˆç™½èƒŒæ™¯ã‚’é€éï¼‰
  return await sharp(buffer)
    .threshold(240) // ç™½ã„éƒ¨åˆ†ã‚’æ¤œå‡º
    .negate() // åè»¢
    .toColorspace('b-w') // ç™½é»’åŒ–
    .png()
    .toBuffer()

  // ã‚ˆã‚Šé«˜åº¦ãªèƒŒæ™¯é™¤å»ã«ã¯remove.bgã‚„MLä½¿ç”¨ã‚’æ¨å¥¨
}
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥

```typescript
// lib/qr/cache.ts
import { unstable_cache } from 'next/cache'

/**
 * QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆçµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
 */
export const getCachedQR = unstable_cache(
  async (url: string, designId: string) => {
    return await generateQRCode({
      url,
      design: /* ... */,
      customization: /* ... */
    })
  },
  ['qr-generation'],
  {
    revalidate: 3600, // 1æ™‚é–“
    tags: ['qr']
  }
)
```

### ãƒ¡ãƒ¢ãƒªç®¡ç†

```typescript
// å¤§é‡ç”Ÿæˆæ™‚ã®ãƒ¡ãƒ¢ãƒªç®¡ç†
export async function batchGenerateQRs(
  urls: string[]
): Promise<Buffer[]> {
  const BATCH_SIZE = 10
  const results: Buffer[] = []

  for (let i = 0; i < urls.length; i += BATCH_SIZE) {
    const batch = urls.slice(i, i + BATCH_SIZE)

    // ãƒãƒƒãƒå‡¦ç†
    const batchResults = await Promise.all(
      batch.map(url => generateBasicQR(url))
    )

    results.push(...batchResults)

    // ãƒ¡ãƒ¢ãƒªè§£æ”¾ã®ãŸã‚ã®å¾…æ©Ÿ
    if (global.gc) {
      global.gc()
    }

    // æ¬¡ã®ãƒãƒƒãƒã¾ã§å¾…æ©Ÿ
    await new Promise(resolve => setTimeout(resolve, 100))
  }

  return results
}
```

### Sharpã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

```typescript
// Sharpè¨­å®šã®æœ€é©åŒ–
import sharp from 'sharp'

// ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š
sharp.cache(false) // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ï¼ˆãƒ¡ãƒ¢ãƒªç¯€ç´„ï¼‰
sharp.concurrency(4) // ä¸¦åˆ—å‡¦ç†æ•°åˆ¶é™
sharp.simd(true) // SIMDæœ€é©åŒ–æœ‰åŠ¹åŒ–
```

---

## æœ¬ç•ªç’°å¢ƒã§ã®è€ƒæ…®äº‹é …

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```typescript
// lib/qr/error-handling.ts

export class QRGenerationError extends Error {
  constructor(
    message: string,
    public code: string,
    public details?: any
  ) {
    super(message)
    this.name = 'QRGenerationError'
  }
}

export async function generateQRSafely(
  options: QRCodeOptions
): Promise<Buffer> {
  try {
    // URLãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    new URL(options.url)

    // ã‚µã‚¤ã‚ºãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (options.customization.size < 256 || options.customization.size > 4096) {
      throw new QRGenerationError(
        'Invalid size',
        'INVALID_SIZE',
        { size: options.customization.size }
      )
    }

    return await generateQRCode(options)
  } catch (error) {
    if (error instanceof QRGenerationError) {
      throw error
    }

    // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
    throw new QRGenerationError(
      'QR generation failed',
      'GENERATION_FAILED',
      { originalError: error }
    )
  }
}
```

### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š

```typescript
// lib/qr/timeout.ts

export async function generateWithTimeout(
  options: QRCodeOptions,
  timeoutMs: number = 10000
): Promise<Buffer> {
  return await Promise.race([
    generateQRCode(options),
    new Promise<never>((_, reject) => {
      setTimeout(() => {
        reject(new Error(`QR generation timed out after ${timeoutMs}ms`))
      }, timeoutMs)
    })
  ])
}
```

### ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

```typescript
// lib/qr/metrics.ts

export async function generateWithMetrics(
  options: QRCodeOptions
): Promise<Buffer> {
  const startTime = Date.now()

  try {
    const result = await generateQRCode(options)
    const duration = Date.now() - startTime

    // ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²
    console.log({
      event: 'qr_generated',
      duration,
      size: options.customization.size,
      hasLogo: !!options.logo,
      design: options.design.style
    })

    return result
  } catch (error) {
    console.error({
      event: 'qr_generation_failed',
      duration: Date.now() - startTime,
      error
    })

    throw error
  }
}
```

---

## ğŸŒ å¿…é ˆå‚ç…§ãƒªã‚½ãƒ¼ã‚¹

### å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

1. [node-qrcode Documentation](https://github.com/soldair/node-qrcode) - QRCodeå…¬å¼
2. [Sharp Documentation](https://sharp.pixelplumbing.com/) - Sharpå…¬å¼
3. [QR Code Specification (ISO/IEC 18004)](https://www.iso.org/standard/62021.html) - ISOæ¨™æº–
4. [QR Code Tutorial](https://www.thonky.com/qr-code-tutorial/) - QRä»•æ§˜è©³è§£
5. [Error Correction in QR Codes](https://www.qrcode.com/en/about/error_correction.html) - ã‚¨ãƒ©ãƒ¼è¨‚æ­£è©³ç´°

### å®Ÿè£…è¨˜äº‹ãƒ»ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«

6. [Building a QR Code Generator - Medium](https://medium.com/@example/qr-code-generator-12345) - å®Ÿè£…ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«
7. [Sharp Image Processing Guide](https://sharp.pixelplumbing.com/api-composite) - ç”»åƒåˆæˆã‚¬ã‚¤ãƒ‰
8. [Optimizing QR Code Generation - Dev.to](https://dev.to/example/optimizing-qr) - æœ€é©åŒ–ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯
9. [QR Code Best Practices](https://www.qr-code-generator.com/qr-code-marketing/qr-codes-basics/) - ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
10. [High-Performance Image Processing](https://sharp.pixelplumbing.com/performance) - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### è¿½åŠ ãƒªã‚½ãƒ¼ã‚¹

11. [QR Code Generator Examples](https://github.com/topics/qr-code-generator) - GitHubä¾‹
12. [Stack Overflow - QR Code Tag](https://stackoverflow.com/questions/tagged/qr-code) - Q&A
13. [Sharp GitHub Discussions](https://github.com/lovell/sharp/discussions) - ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚µãƒãƒ¼ãƒˆ
14. [QR Code Design Inspiration](https://www.qr-code-generator.com/qr-code-examples/) - ãƒ‡ã‚¶ã‚¤ãƒ³äº‹ä¾‹
15. [Image Optimization Techniques](https://web.dev/fast/#optimize-your-images) - ç”»åƒæœ€é©åŒ–

---

**æ›´æ–°æ—¥**: 2026-01-04
**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0
**å¯¾è±¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: QR Designer v3.0
