# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ & ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å®Œå…¨ã‚¬ã‚¤ãƒ‰ - QR Designer v3.0

> **æœ€çµ‚æ›´æ–°**: 2026-01-04
> **å¯¾è±¡**: QR Designer v3.0 æœ¬ç•ªç’°å¢ƒ
> **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«**: Enterprise Grade

---

## ğŸ“š ç›®æ¬¡

1. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦)
2. [èªè¨¼ã¨ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡](#èªè¨¼ã¨ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡)
3. [ãƒ‡ãƒ¼ã‚¿ä¿è­·ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼](#ãƒ‡ãƒ¼ã‚¿ä¿è­·ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼)
4. [APIã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#apiã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
5. [ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
6. [è„…å¨ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã¨å¯¾ç­–](#è„…å¨ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã¨å¯¾ç­–)
7. [ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹](#ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹)
8. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ã¨ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œ](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ã¨ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œ)
9. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### å¤šå±¤é˜²å¾¡æˆ¦ç•¥ï¼ˆDefense in Depthï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 7: Application Security (èªè¨¼ãƒ»èªå¯ãƒ»å…¥åŠ›æ¤œè¨¼)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 6: API Security (ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ»CORSãƒ»ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 5: Database Security (RLSãƒ»æš—å·åŒ–ãƒ»ç›£æŸ»ãƒ­ã‚°)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 4: Transport Security (HTTPS/TLS 1.3ãƒ»HSTS)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 3: Infrastructure (Vercel Firewallãƒ»DDoSä¿è­·)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 2: Network Security (VPCãƒ»ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ãƒ«ãƒ¼ãƒ«)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 1: Physical Security (Vercelãƒ»Supabase ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ³ã‚¿ãƒ¼)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸå‰‡

1. **æœ€å°æ¨©é™ã®åŸå‰‡ï¼ˆLeast Privilegeï¼‰**: å¿…è¦æœ€å°é™ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®ã¿ä»˜ä¸
2. **ã‚¼ãƒ­ãƒˆãƒ©ã‚¹ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¤œè¨¼
3. **æš—å·åŒ–ï¼ˆEncryption Everywhereï¼‰**: ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜æ™‚ãƒ»è»¢é€æ™‚ã¨ã‚‚ã«æš—å·åŒ–
4. **å¤šè¦ç´ é˜²å¾¡ï¼ˆDefense in Depthï¼‰**: è¤‡æ•°ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ã‚¤ãƒ¤ãƒ¼
5. **ç›£æŸ»å¯èƒ½æ€§ï¼ˆAuditabilityï¼‰**: ã™ã¹ã¦ã®æ“ä½œã‚’ãƒ­ã‚°ã«è¨˜éŒ²

---

## èªè¨¼ã¨ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

### Google OAuth 2.0å®Ÿè£…

```typescript
// lib/supabase/auth.ts
import { createClient } from '@/lib/supabase/server'

export async function signInWithGoogle() {
  const supabase = await createClient()

  const { data, error } = await supabase.auth.signInWithOAuth({
    provider: 'google',
    options: {
      redirectTo: `${process.env.NEXT_PUBLIC_APP_URL}/auth/callback`,
      queryParams: {
        access_type: 'offline',
        prompt: 'consent',
      },
      scopes: 'email profile', // æœ€å°é™ã®ã‚¹ã‚³ãƒ¼ãƒ—
    }
  })

  if (error) {
    console.error('OAuth error:', error)
    throw new Error('èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ')
  }

  return data
}
```

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

```typescript
// middleware.ts - ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs'
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export async function middleware(req: NextRequest) {
  const res = NextResponse.next()
  const supabase = createMiddlewareClient({ req, res })

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼
  const {
    data: { session },
  } = await supabase.auth.getSession()

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ¤œè¨¼ï¼ˆ24æ™‚é–“ï¼‰
  if (session) {
    const sessionAge = Date.now() - new Date(session.created_at).getTime()
    const MAX_SESSION_AGE = 24 * 60 * 60 * 1000 // 24æ™‚é–“

    if (sessionAge > MAX_SESSION_AGE) {
      await supabase.auth.signOut()
      return NextResponse.redirect(new URL('/login', req.url))
    }
  }

  // ä¿è­·ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆã®ãƒã‚§ãƒƒã‚¯
  if (req.nextUrl.pathname.startsWith('/history') && !session) {
    return NextResponse.redirect(new URL('/login', req.url))
  }

  return res
}

export const config = {
  matcher: ['/history/:path*', '/api/:path*']
}
```

### Row Level Security (RLS) ãƒãƒªã‚·ãƒ¼

```sql
-- user_profilesãƒ†ãƒ¼ãƒ–ãƒ«ã®RLS
CREATE POLICY "Users can view own profile"
ON user_profiles FOR SELECT
USING (auth.uid() = user_id);

CREATE POLICY "Users can update own profile"
ON user_profiles FOR UPDATE
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- qr_historyãƒ†ãƒ¼ãƒ–ãƒ«ã®RLS
CREATE POLICY "Users can view own history"
ON qr_history FOR SELECT
USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own history"
ON qr_history FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- Service Roleã®ã¿ãŒå…¨ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
CREATE POLICY "Service role full access"
ON user_profiles
USING (current_setting('request.jwt.claims', true)::json->>'role' = 'service_role');
```

---

## ãƒ‡ãƒ¼ã‚¿ä¿è­·ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼

### ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–

```typescript
// lib/security/encryption.ts
import crypto from 'crypto'

const ALGORITHM = 'aes-256-gcm'
const KEY = Buffer.from(process.env.ENCRYPTION_KEY!, 'hex') // 32ãƒã‚¤ãƒˆ

export function encrypt(text: string): string {
  const iv = crypto.randomBytes(16)
  const cipher = crypto.createCipheriv(ALGORITHM, KEY, iv)

  let encrypted = cipher.update(text, 'utf8', 'hex')
  encrypted += cipher.final('hex')

  const authTag = cipher.getAuthTag()

  // IV + èªè¨¼ã‚¿ã‚° + æš—å·åŒ–ãƒ‡ãƒ¼ã‚¿
  return iv.toString('hex') + ':' + authTag.toString('hex') + ':' + encrypted
}

export function decrypt(encryptedData: string): string {
  const parts = encryptedData.split(':')
  const iv = Buffer.from(parts[0], 'hex')
  const authTag = Buffer.from(parts[1], 'hex')
  const encrypted = parts[2]

  const decipher = crypto.createDecipheriv(ALGORITHM, KEY, iv)
  decipher.setAuthTag(authTag)

  let decrypted = decipher.update(encrypted, 'hex', 'utf8')
  decrypted += decipher.final('utf8')

  return decrypted
}
```

### å€‹äººæƒ…å ±ä¿è­·ï¼ˆGDPR/CCPAå¯¾å¿œï¼‰

```typescript
// lib/privacy/data-retention.ts
export async function deleteUserData(userId: string) {
  const supabase = createClient()

  // GDPRæº–æ‹ : ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨å‰Šé™¤
  await supabase.from('qr_history').delete().eq('user_id', userId)
  await supabase.from('user_profiles').delete().eq('user_id', userId)

  // ç›£æŸ»ãƒ­ã‚°ã«è¨˜éŒ²
  await supabase.from('audit_logs').insert({
    event_type: 'user_data_deleted',
    user_id: userId,
    timestamp: new Date().toISOString(),
    ip_address: getClientIP()
  })
}

// ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé–“ã®è‡ªå‹•å‰Šé™¤ï¼ˆ90æ—¥ï¼‰
export async function cleanupOldData() {
  const supabase = createClient()
  const cutoffDate = new Date()
  cutoffDate.setDate(cutoffDate.getDate() - 90)

  await supabase
    .from('qr_history')
    .delete()
    .lt('created_at', cutoffDate.toISOString())
}
```

### PIIï¼ˆå€‹äººè­˜åˆ¥æƒ…å ±ï¼‰ã®ãƒã‚¹ã‚­ãƒ³ã‚°

```typescript
// lib/privacy/pii-masking.ts
export function maskEmail(email: string): string {
  const [local, domain] = email.split('@')
  const maskedLocal = local.charAt(0) + '***' + local.slice(-1)
  return `${maskedLocal}@${domain}`
}

export function maskIP(ip: string): string {
  // IPv4: 192.168.1.100 â†’ 192.168.*.*
  return ip.replace(/\.\d+\.\d+$/, '.*.*')
}

// ãƒ­ã‚°å‡ºåŠ›æ™‚ã«è‡ªå‹•ãƒã‚¹ã‚­ãƒ³ã‚°
export function sanitizeLog(data: any) {
  const sanitized = { ...data }

  if (sanitized.email) sanitized.email = maskEmail(sanitized.email)
  if (sanitized.ip) sanitized.ip = maskIP(sanitized.ip)

  return sanitized
}
```

---

## APIã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…

```typescript
// lib/security/rate-limit.ts
import { createClient } from '@/lib/supabase/server'

interface RateLimitConfig {
  windowMs: number // ã‚¿ã‚¤ãƒ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆãƒŸãƒªç§’ï¼‰
  maxRequests: number // æœ€å¤§ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°
}

export async function checkRateLimit(
  userId: string,
  endpoint: string,
  config: RateLimitConfig
): Promise<{ allowed: boolean; retryAfter?: number }> {
  const supabase = await createClient()

  const windowStart = new Date(Date.now() - config.windowMs)

  // éå»ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚«ã‚¦ãƒ³ãƒˆ
  const { count, error } = await supabase
    .from('rate_limit_logs')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', userId)
    .eq('endpoint', endpoint)
    .gte('created_at', windowStart.toISOString())

  if (error) throw error

  if ((count || 0) >= config.maxRequests) {
    const retryAfter = Math.ceil(config.windowMs / 1000) // ç§’å˜ä½
    return { allowed: false, retryAfter }
  }

  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨˜éŒ²
  await supabase.from('rate_limit_logs').insert({
    user_id: userId,
    endpoint,
    created_at: new Date().toISOString()
  })

  return { allowed: true }
}
```

### å…¥åŠ›æ¤œè¨¼ã¨ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³

```typescript
// lib/security/validation.ts
import { z } from 'zod'
import validator from 'validator'

// URLã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼
export const urlSchema = z.string()
  .url('æœ‰åŠ¹ãªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
  .refine(
    (url) => {
      const parsed = new URL(url)
      // å®‰å…¨ãªãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®ã¿è¨±å¯
      return ['http:', 'https:'].includes(parsed.protocol)
    },
    { message: 'HTTP/HTTPSã®ã¿ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™' }
  )
  .refine(
    (url) => {
      // SSRFã‚’é˜²ããŸã‚ãƒ­ãƒ¼ã‚«ãƒ«IPã‚’æ‹’å¦
      const parsed = new URL(url)
      const hostname = parsed.hostname

      if (
        hostname === 'localhost' ||
        hostname.startsWith('127.') ||
        hostname.startsWith('192.168.') ||
        hostname.startsWith('10.') ||
        hostname.match(/^172\.(1[6-9]|2\d|3[01])\./)
      ) {
        return false
      }
      return true
    },
    { message: 'ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®URLã¯ä½¿ç”¨ã§ãã¾ã›ã‚“' }
  )

// QRã‚³ãƒ¼ãƒ‰è¨­å®šæ¤œè¨¼
export const qrConfigSchema = z.object({
  size: z.number().int().min(256).max(4096),
  errorCorrectionLevel: z.enum(['L', 'M', 'Q', 'H']),
  cornerRadius: z.number().min(0).max(50),
  logoSize: z.number().min(10).max(35).optional(),
  format: z.enum(['png', 'jpeg', 'svg', 'pdf'])
})

// HTMLã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
export function sanitizeHTML(html: string): string {
  return validator.escape(html)
}

// SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼ˆSupabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯è‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰
export function sanitizeSQL(input: string): string {
  // Supabaseã¯è‡ªå‹•çš„ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨
  // è¿½åŠ ã®æ¤œè¨¼ã¨ã—ã¦å±é™ºãªæ–‡å­—ã‚’é™¤å»
  return input.replace(/['";\\]/g, '')
}
```

### CORSè¨­å®š

```typescript
// next.config.ts
const config = {
  async headers() {
    return [
      {
        source: '/api/:path*',
        headers: [
          {
            key: 'Access-Control-Allow-Origin',
            value: process.env.NODE_ENV === 'production'
              ? 'https://qr-designer.vercel.app'
              : 'http://localhost:3000'
          },
          {
            key: 'Access-Control-Allow-Methods',
            value: 'GET, POST, OPTIONS'
          },
          {
            key: 'Access-Control-Allow-Headers',
            value: 'Content-Type, Authorization'
          },
          {
            key: 'Access-Control-Max-Age',
            value: '86400' // 24æ™‚é–“
          }
        ]
      }
    ]
  }
}
```

---

## ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### ç’°å¢ƒå¤‰æ•°ã®å®‰å…¨ãªç®¡ç†

```typescript
// lib/security/env-validator.ts
import { z } from 'zod'

const envSchema = z.object({
  // å¿…é ˆã®ç§˜å¯†éµ
  GOOGLE_GEMINI_API_KEY: z.string().min(30),
  SUPABASE_SERVICE_ROLE_KEY: z.string().min(100),
  ENCRYPTION_KEY: z.string().length(64), // 32ãƒã‚¤ãƒˆã®hex

  // ãƒ‘ãƒ–ãƒªãƒƒã‚¯å¤‰æ•°
  NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(100),

  // ã‚ªãƒ—ã‚·ãƒ§ãƒ³
  SENTRY_DSN: z.string().url().optional(),
  VERCEL_ENV: z.enum(['production', 'preview', 'development']).optional()
})

export function validateEnv() {
  try {
    envSchema.parse(process.env)
  } catch (error) {
    if (error instanceof z.ZodError) {
      console.error('âŒ ç’°å¢ƒå¤‰æ•°æ¤œè¨¼ã‚¨ãƒ©ãƒ¼:')
      error.errors.forEach((err) => {
        console.error(`  - ${err.path.join('.')}: ${err.message}`)
      })
      process.exit(1)
    }
    throw error
  }
}

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚ã«å®Ÿè¡Œ
if (process.env.NODE_ENV === 'production') {
  validateEnv()
}
```

### Secret Rotationï¼ˆã‚­ãƒ¼ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰

```bash
#!/bin/bash
# scripts/rotate-secrets.sh

# Supabase JWT Secret Rotation
echo "ğŸ”„ Rotating Supabase JWT Secret..."
supabase secrets set JWT_SECRET=$(openssl rand -hex 32)

# Encryption Key Rotation
echo "ğŸ”„ Rotating Encryption Key..."
NEW_ENCRYPTION_KEY=$(openssl rand -hex 32)
vercel env add ENCRYPTION_KEY production <<< "$NEW_ENCRYPTION_KEY"

# Gemini API Key Rotation (æ‰‹å‹•ã§æ–°ã—ã„ã‚­ãƒ¼ã‚’ç”Ÿæˆ)
echo "âš ï¸  Gemini API Keyã¯æ‰‹å‹•ã§Google AI Studioã§ç”Ÿæˆã—ã¦ãã ã•ã„"
echo "https://makersuite.google.com/app/apikey"

echo "âœ… Secret rotation completed"
```

---

## è„…å¨ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã¨å¯¾ç­–

### OWASP Top 10å¯¾ç­–

| è„…å¨ | å¯¾ç­– | å®Ÿè£… |
|------|------|------|
| **A01: Broken Access Control** | RLS + èªè¨¼ãƒã‚§ãƒƒã‚¯ | Supabase RLS ãƒãƒªã‚·ãƒ¼ |
| **A02: Cryptographic Failures** | TLS 1.3 + AES-256-GCM | Vercelè‡ªå‹•HTTPS + æš—å·åŒ–é–¢æ•° |
| **A03: Injection** | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒª | Supabaseè‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ— + Zodæ¤œè¨¼ |
| **A04: Insecure Design** | ã‚»ã‚­ãƒ¥ã‚¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ | å¤šå±¤é˜²å¾¡ + ã‚¼ãƒ­ãƒˆãƒ©ã‚¹ãƒˆ |
| **A05: Security Misconfiguration** | ç’°å¢ƒå¤‰æ•°æ¤œè¨¼ | env-validator.ts |
| **A06: Vulnerable Components** | ä¾å­˜é–¢ä¿‚ã‚¹ã‚­ãƒ£ãƒ³ | npm audit + Dependabot |
| **A07: Authentication Failures** | OAuth 2.0 + ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† | Supabase Auth + middleware |
| **A08: Software Integrity** | SRI + ã‚³ãƒ¼ãƒ‰ç½²å | Vercelè‡ªå‹•æœ€é©åŒ– |
| **A09: Logging Failures** | ç›£æŸ»ãƒ­ã‚° | audit_logs ãƒ†ãƒ¼ãƒ–ãƒ« |
| **A10: SSRF** | URLæ¤œè¨¼ + ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ¶é™ | urlSchema + ãƒ­ãƒ¼ã‚«ãƒ«IPæ‹’å¦ |

### DDoSå¯¾ç­–

```typescript
// lib/security/ddos-protection.ts
import { NextRequest } from 'next/server'

// IP-based rate limiting (Vercel Edge Middleware)
export async function ddosProtection(req: NextRequest) {
  const ip = req.ip || req.headers.get('x-forwarded-for')

  if (!ip) {
    return new Response('Forbidden', { status: 403 })
  }

  // Vercel Firewall Rules (è¨­å®šä¾‹)
  // Rate Limit: 100 requests per minute per IP
  // Burst: 20 requests per second

  return null // æ­£å¸¸ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ
}
```

---

## ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹

### GDPRæº–æ‹ 

```typescript
// app/api/privacy/export-data/route.ts
export async function GET(request: Request) {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    return new Response('Unauthorized', { status: 401 })
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆGDPR Article 20ï¼‰
  const [profile, history] = await Promise.all([
    supabase.from('user_profiles').select('*').eq('user_id', user.id).single(),
    supabase.from('qr_history').select('*').eq('user_id', user.id)
  ])

  const exportData = {
    user: {
      id: user.id,
      email: user.email,
      created_at: user.created_at
    },
    profile: profile.data,
    history: history.data,
    exported_at: new Date().toISOString()
  }

  return new Response(JSON.stringify(exportData, null, 2), {
    headers: {
      'Content-Type': 'application/json',
      'Content-Disposition': 'attachment; filename=my-data.json'
    }
  })
}
```

### CookieåŒæ„ç®¡ç†

```typescript
// app/components/CookieConsent.tsx
'use client'

import { useState, useEffect } from 'react'

export default function CookieConsent() {
  const [showBanner, setShowBanner] = useState(false)

  useEffect(() => {
    const consent = localStorage.getItem('cookie-consent')
    if (!consent) {
      setShowBanner(true)
    }
  }, [])

  const acceptCookies = () => {
    localStorage.setItem('cookie-consent', 'accepted')
    setShowBanner(false)

    // Google Analyticsã‚’æœ‰åŠ¹åŒ–
    if (typeof window.gtag !== 'undefined') {
      window.gtag('consent', 'update', {
        analytics_storage: 'granted'
      })
    }
  }

  if (!showBanner) return null

  return (
    <div className="fixed bottom-0 left-0 right-0 bg-gray-900 text-white p-4 z-50">
      <div className="max-w-6xl mx-auto flex items-center justify-between">
        <p className="text-sm">
          ã“ã®ã‚µã‚¤ãƒˆã¯Cookieã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’å‘ä¸Šã•ã›ã¦ã„ã¾ã™ã€‚
          <a href="/privacy" className="underline ml-2">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
        </p>
        <button
          onClick={acceptCookies}
          className="bg-blue-600 px-6 py-2 rounded hover:bg-blue-700"
        >
          åŒæ„ã™ã‚‹
        </button>
      </div>
    </div>
  )
}
```

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ã¨ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œ

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°

```sql
-- ç›£æŸ»ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  event_type TEXT NOT NULL,
  user_id UUID REFERENCES auth.users(id),
  ip_address TEXT,
  user_agent TEXT,
  resource_type TEXT,
  resource_id TEXT,
  action TEXT,
  status TEXT,
  error_message TEXT,
  metadata JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);
CREATE INDEX idx_audit_logs_event_type ON audit_logs(event_type);
```

### ç•°å¸¸æ¤œçŸ¥ã‚¢ãƒ©ãƒ¼ãƒˆ

```typescript
// lib/security/anomaly-detection.ts
export async function detectAnomalies(userId: string) {
  const supabase = createClient()

  // éå»1æ™‚é–“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°
  const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000)
  const { count } = await supabase
    .from('audit_logs')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', userId)
    .gte('created_at', oneHourAgo.toISOString())

  // ç•°å¸¸ãªé »åº¦ï¼ˆ1æ™‚é–“ã«100å›ä»¥ä¸Šï¼‰
  if ((count || 0) > 100) {
    await sendSecurityAlert({
      type: 'HIGH_FREQUENCY_ACCESS',
      userId,
      count,
      threshold: 100
    })
  }

  // ç•°å¸¸ãªIPã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´
  const { data: recentIPs } = await supabase
    .from('audit_logs')
    .select('ip_address')
    .eq('user_id', userId)
    .gte('created_at', oneHourAgo.toISOString())
    .limit(10)

  const uniqueIPs = new Set(recentIPs?.map((log) => log.ip_address))
  if (uniqueIPs.size > 3) {
    await sendSecurityAlert({
      type: 'MULTIPLE_IP_ADDRESSES',
      userId,
      ipCount: uniqueIPs.size
    })
  }
}
```

### ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œãƒ—ãƒ­ã‚»ã‚¹

```markdown
## ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œæ‰‹é †

### Phase 1: æ¤œçŸ¥ (Detection)
1. è‡ªå‹•ã‚¢ãƒ©ãƒ¼ãƒˆå—ä¿¡ï¼ˆSentry, Vercel Logsï¼‰
2. ç•°å¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç‰¹å®š
3. å½±éŸ¿ç¯„å›²ã®åˆæœŸè©•ä¾¡

### Phase 2: å°ã˜è¾¼ã‚ (Containment)
1. ç–‘ã‚ã—ã„IPã‚’ãƒ–ãƒ­ãƒƒã‚¯
2. å½±éŸ¿ã‚’å—ã‘ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–
3. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’å¼·åŒ–

### Phase 3: èª¿æŸ» (Investigation)
1. ç›£æŸ»ãƒ­ã‚°ã‚’åˆ†æ
2. æ”»æ’ƒãƒ™ã‚¯ãƒˆãƒ«ã‚’ç‰¹å®š
3. ãƒ‡ãƒ¼ã‚¿ä¾µå®³ã®æœ‰ç„¡ã‚’ç¢ºèª

### Phase 4: å¾©æ—§ (Recovery)
1. è„†å¼±æ€§ã‚’ä¿®æ­£
2. ã‚·ã‚¹ãƒ†ãƒ ã‚’å¾©å…ƒ
3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒã‚’é©ç”¨

### Phase 5: äº‹å¾Œåˆ†æ (Post-Incident)
1. ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
2. å†ç™ºé˜²æ­¢ç­–ã®ç­–å®š
3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼æ›´æ–°
```

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯

- [ ] **èªè¨¼**
  - [ ] OAuth 2.0è¨­å®šå®Œäº†
  - [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ24æ™‚é–“ï¼‰
  - [ ] CSRFä¿è­·æœ‰åŠ¹åŒ–

- [ ] **ãƒ‡ãƒ¼ã‚¿ä¿è­·**
  - [ ] RLSæœ‰åŠ¹åŒ–ç¢ºèª
  - [ ] æš—å·åŒ–ã‚­ãƒ¼è¨­å®š
  - [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š

- [ ] **API**
  - [ ] ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…
  - [ ] å…¥åŠ›æ¤œè¨¼å®Ÿè£…
  - [ ] CORSè¨­å®š

- [ ] **ã‚¤ãƒ³ãƒ•ãƒ©**
  - [ ] HTTPSå¼·åˆ¶ï¼ˆHSTSï¼‰
  - [ ] ç’°å¢ƒå¤‰æ•°æ¤œè¨¼
  - [ ] Secret Rotationè¨ˆç”»

- [ ] **ç›£è¦–**
  - [ ] ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ï¼ˆSentryï¼‰
  - [ ] ç›£æŸ»ãƒ­ã‚°æœ‰åŠ¹åŒ–
  - [ ] ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

### æœˆæ¬¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼

- [ ] ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆnpm auditï¼‰
- [ ] ç›£æŸ»ãƒ­ã‚°ãƒ¬ãƒ“ãƒ¥ãƒ¼
- [ ] ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãƒ¬ãƒ“ãƒ¥ãƒ¼
- [ ] Secret Rotationå®Ÿæ–½
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒé©ç”¨

---

## ğŸŒ å¿…é ˆå‚ç…§ãƒªã‚½ãƒ¼ã‚¹

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

1. [OWASP Top 10](https://owasp.org/www-project-top-ten/) - Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯
2. [OWASP API Security Top 10](https://owasp.org/www-project-api-security/) - APIã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
3. [Next.js Security](https://nextjs.org/docs/authentication) - Next.jsèªè¨¼ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
4. [Vercel Security](https://vercel.com/docs/security) - Vercelã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰
5. [Supabase Security](https://supabase.com/docs/guides/auth/row-level-security) - RLSãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹

6. [GDPR Official](https://gdpr.eu/) - GDPRå®Œå…¨ã‚¬ã‚¤ãƒ‰
7. [CCPA Compliance](https://oag.ca.gov/privacy/ccpa) - ã‚«ãƒªãƒ•ã‚©ãƒ«ãƒ‹ã‚¢å·ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼æ³•
8. [ISO 27001](https://www.iso.org/isoiec-27001-information-security.html) - æƒ…å ±ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¨™æº–

### ãƒ„ãƒ¼ãƒ«

9. [Snyk](https://snyk.io/) - è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒŠãƒ¼
10. [Sentry](https://sentry.io/welcome/) - ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
11. [npm audit](https://docs.npmjs.com/cli/v9/commands/npm-audit) - ä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
12. [OWASP ZAP](https://www.zaproxy.org/) - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«

### å­¦ç¿’ãƒªã‚½ãƒ¼ã‚¹

13. [Web Security Academy](https://portswigger.net/web-security) - å®Ÿè·µçš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å­¦ç¿’
14. [Google Security Blog](https://security.googleblog.com/) - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æœ€æ–°æƒ…å ±
15. [Krebs on Security](https://krebsonsecurity.com/) - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‹ãƒ¥ãƒ¼ã‚¹

---

**æ›´æ–°æ—¥**: 2026-01-04
**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0
**å¯¾è±¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: QR Designer v3.0
**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«**: Enterprise Grade
